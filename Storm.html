<!DOCTYPE html>
<html lang="en">
<head>
  <!-- This is the head section, it sets up basic page info like character encoding and screen size -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storm</title> <!-- This sets the title shown in the browser tab -->
  <link rel="icon" href="visuals/favicon.png" type="image/png"> <!-- This adds a small icon for the website tab -->
  
  <!-- These scripts load external tools: SocketIO for real-time chat, Marked for formatting text, Prism for code highlighting, and Google Analytics for tracking -->
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZG39HWNCCF"></script>
  <script>
    window.dataLayer = window.dataLayer || []; // This sets up a data layer for Google Analytics
    function gtag(){dataLayer.push(arguments);} // This function sends data to Google Analytics
    gtag('js', new Date()); // This tells Google when the page loaded
    gtag('config', 'G-ZG39HWNCCF'); // This sets up the tracking ID
  </script>

  <style>
    <!-- This is the CSS section, it styles the whole page -->
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@400;700&display=swap'); <!-- Loads custom fonts -->
    * { margin: 0; padding: 0; box-sizing: border-box; } <!-- Resets margins and padding, ensures box sizing includes padding -->
    body {
      font-family: 'Playfair Display', serif; <!-- Sets the main font -->
      background-color: #f4e2cf; <!-- Light beige background color -->
      color: #610000; <!-- Dark red text color -->
      display: flex; <!-- Uses flexbox for layout -->
      flex-direction: column; <!-- Stacks content vertically -->
      align-items: center; <!-- Centers content horizontally -->
    }
    .logo { position: absolute; top: 20px; left: 20px; z-index: 100; } <!-- Places the logo at the top left, above other elements -->
    .logo img { width: auto; max-width: 233px; height: auto; max-height: 80px; transition: transform 0.3s ease; } <!-- Sets logo size and adds a smooth scaling effect -->
    .navigation { position: absolute; top: 20px; right: 50px; display: flex; gap: 20px; z-index: 100; } <!-- Places navigation menu at top right -->
    .navigation a { text-decoration: none; font-weight: bold; color: #610000; font-size: 16px; } <!-- Styles navigation links -->
    .hamburger-menu { display: none; position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: #610000; z-index: 100; } <!-- Hidden menu icon for mobile, shows on click -->
    .mobile-nav { display: none; position: absolute; top: 60px; right: 20px; background-color: #f4e2cf; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 5px; padding: 10px; z-index: 100; } <!-- Dropdown menu for mobile -->
    .mobile-nav a { display: block; text-decoration: none; color: #610000; font-weight: bold; padding: 10px; } <!-- Styles mobile menu links -->
    @media (max-width: 768px) { .navigation { display: none; } .hamburger-menu { display: block; } } <!-- Hides main nav and shows hamburger on small screens -->
    .content-container { position: relative; display: flex; justify-content: center; align-items: flex-start; gap: 20px; width: 80%; margin-top: 120px; flex-wrap: wrap; } <!-- Main content area with sidebar and chat -->
    .sidebar { width: 20%; background: white; padding: 20px; border-radius: 16px; box-shadow: 0px 4px 15px rgba(0,0,0,0.1); text-align: left; overflow-y: auto; max-height: 80vh; } <!-- Sidebar for chat history -->
    .chat-container { flex-grow: 1; background: white; padding: 20px; border-radius: 16px; box-shadow: 0px 4px 15px rgba(0,0,0,0.1); text-align: center; display: flex; flex-direction: column; justify-content: center; width: 65%; } <!-- Main chat area -->
    #chat-box { border: 1px solid #ddd; padding: 15px; height: 300px; overflow-y: auto; text-align: left; border-radius: 8px; background-color: #fff; white-space: pre-wrap; word-wrap: break-word; } <!-- Chat display area with scrolling -->
    #chat-box p { margin-bottom: 5px; line-height: 1.4; } <!-- Spacing and line height for paragraphs -->
    #chat-box h1, #chat-box h2, #chat-box h3 { color: #610000; margin-top: 15px; } <!-- Header styles -->
    #chat-box ul { margin-left: 20px; list-style-type: disc; } <!-- List styling -->
    #chat-box a { color: #007bff; text-decoration: none; } <!-- Link colors -->
    #chat-box a:hover { text-decoration: underline; } <!-- Link hover effect -->
    #chat-box iframe { width: 100%; height: 200px; border: none; } <!-- Iframe for HTML previews -->
    #chat-box pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; } <!-- Code block styling -->
    .input-container { display: flex; justify-content: center; gap: 10px; margin-top: 10px; align-items: center; } <!-- Container for input and buttons -->
    .chat-btn { height: 48px; padding: 0 20px; background: #610000; color: white; border: none; cursor: pointer; border-radius: 8px; } <!-- Button styling -->
    .chat-btn img { max-width: 60%; max-height: 60%; object-fit: contain; display: block; margin: auto; } <!-- Image inside buttons -->
    .input-wrapper { position: relative; flex-grow: 1; } <!-- Wrapper for input field -->
    #user-input { width: 100%; height: 48px; padding: 0 12px; border: 1px solid #610000; border-radius: 8px; } <!-- Input field styling -->
    #namespace-selector { position: absolute; top: 100%; left: 0; width: 100%; margin-top: 4px; padding: 10px; border: 1px solid #610000; border-radius: 8px; background-color: #fff; display: none; z-index: 10; } <!-- Dropdown for topic selection -->
    button { height: 48px; padding: 0 20px; background: #610000; color: white; border: none; cursor: pointer; border-radius: 8px; } <!-- General button styling -->
    .trash-icon { max-width: 55%; max-height: 55%; object-fit: contain; display: block; margin: auto; } <!-- Trash icon styling -->
    button:hover { background: #3E5879; } <!-- Button hover color -->
    .message { display: flex; margin: 8px 0; max-width: 100%; } <!-- Message container -->
    .user-message { display: flex; justify-content: flex-end; width: 100%; } <!-- User message alignment -->
    .user-message p { background-color: #f4e2cf; color: #610000; padding: 12px 18px; border-radius: 18px; max-width: 60%; word-wrap: break-word; font-size: 16px; text-align: left; align-self: flex-end; margin-right: 0; } <!-- User message styling -->
    .donna-message { display: block; background-color: #fff; color: #610000; padding: 10px 15px; border-radius: 16px; width: 100%; box-sizing: border-box; word-wrap: break-word; font-size: 16px; text-align: left; } <!-- AI message styling -->
    .donna-message p { background-color: #fff; color: #610000; padding: 10px 15px; border-radius: 16px; max-width: 90%; word-wrap: break-word; } <!-- Paragraph inside AI message -->
    #loginOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(244, 226, 207, 0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; } <!-- Login overlay for password protection -->
    #loginOverlay .login-box { position: relative; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0px 4px 15px rgba(0,0,0,0.1); text-align: center; width: 300px; } <!-- Login box styling -->
    #loginOverlay input { padding: 10px; margin-bottom: 10px; width: 100%; border: 1px solid #610000; border-radius: 4px; } <!-- Input field in login -->
    #loginOverlay button { padding: 10px 20px; background-color: #610000; color: white; border: none; border-radius: 4px; cursor: pointer; } <!-- Login button -->
    #requestCode { position: absolute; bottom: 0; right: 0; padding: 4px 8px; font-size: 14px; font-weight: bold; font-family: sans-serif; background-color: white; color: #610000; border: 1px solid #610000; border-radius: 4px; cursor: pointer; text-decoration: none; } <!-- Link to request code -->
    #loginError { color: red; margin-top: 10px; display: none; } <!-- Error message for wrong password -->
    .mic-icon { width: 24px; height: 24px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23610000"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>') no-repeat center; } <!-- Microphone icon -->
    .mic-active .mic-icon { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FF0000"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>'); } <!-- Active microphone icon (red) -->
    #file-upload { display: none; } <!-- Hides the file input, triggered by a button -->
    .file-upload-btn { height: 48px; padding: 0 20px; background: #610000; color: white; border: none; cursor: pointer; border-radius: 8px; } <!-- Styled button to trigger file upload -->
    .file-upload-btn:hover { background: #3E5879; } <!-- Hover effect for upload button -->
  </style>
</head>
<body>
  <!-- Logo at the top left, links back to home -->
  <div class="logo"><a href="index.html"><img src="visuals/Logo_1.png" alt="Logo"></a></div>
  <!-- Navigation menu at the top right -->
  <div class="navigation"><a href="index.html">Hjem</a><a href="donna.html">Business Donna</a><a href="donna_prof.html">Legal Donna</a><a href="om_os.html">Om os</a></div>
  <!-- Hamburger menu icon for mobile, triggers dropdown -->
  <div class="hamburger-menu" onclick="toggleMenu()">☰</div>
  <!-- Mobile navigation dropdown -->
  <div class="mobile-nav" id="mobileNav"><a href="index.html">Hjem</a><a href="donna.html">Business Donna</a><a href="donna_prof.html">Legal Donna</a><a href="om_os.html">Om os</a></div>
  <!-- Main content container with login overlay, sidebar, and chat -->
  <div class="content-container">
    <!-- Login overlay for password protection -->
    <div id="loginOverlay">
      <div class="login-box">
        <h2>Indtast adgangskode</h2>
        <input type="text" id="loginCode" placeholder="Adgangskode">
        <button onclick="validateLogin()">Log ind</button>
        <a id="requestCode" href="mailto:nikolajstormpetersen@gmail.com?subject=Kodeanmodning&body=Jeg%20kunne%20godt%20t%C3%A6nke%20mig%20en%20kode">Få kode</a>
        <p id="loginError">Forkert kode, prøv igen!</p>
      </div>
    </div>
    <!-- Sidebar for chat history -->
    <div class="sidebar" id="chat-history"></div>
    <!-- Main chat area -->
    <div class="chat-container">
      <h2>Ask Storm</h2>
      <div id="chat-box"></div>
      <!-- Input area with buttons for sending, clearing, voice, and file upload -->
      <div class="input-container">
        <button onclick="clearChat()" class="chat-btn" aria-label="Ryd samtale"><img src="visuals/trash.png" alt="Ryd samtale" class="trash-icon"></button>
        <div class="input-wrapper">
          <input type="text" id="user-input" placeholder="Ask anything...">
          <select id="namespace-selector"><option value="all" selected>All Topics</option></select>
        </div>
        <button onclick="sendMessage()" class="chat-btn" aria-label="Send"><img src="visuals/send.png" alt="Send besked" class="send-icon"></button>
        <button id="micBtn" class="chat-btn" aria-label="Toggle Mic"><span class="mic-icon"></span></button>
        <label for="file-upload" class="file-upload-btn">Upload</label>
        <input type="file" id="file-upload" multiple>
      </div>
    </div>
  </div>
  <script>
    <!-- JavaScript section, handles all interactive features -->
    let messageHistory = []; // Stores the conversation history
    const socket = io('https://storm-backend-wqd0.onrender.com'); // Connects to the backend via WebSocket
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)(); // Sets up speech recognition
    recognition.continuous = true; // Keeps listening until stopped
    recognition.interimResults = false; // Only final results are used
    recognition.lang = 'en-US'; // Language for speech (change to 'da-DK' for Danish)
    recognition.onresult = (event) => { // Handles speech input
      const speech = event.results[event.results.length - 1][0].transcript;
      if (speech.toLowerCase().includes('stop listening')) { // Stops listening on command
        recognition.stop();
        document.getElementById('micBtn').classList.remove('mic-active');
        return;
      }
      messageHistory.push({ role: "user", content: speech });
      socket.emit('message', { messages: messageHistory, namespace: document.getElementById("namespace-selector").value });
      document.getElementById("chat-box").innerHTML += `<div class="message user-message"><p>${speech}</p></div>`;
      document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
    };
    recognition.onerror = (event) => console.error('Speech error:', event.error); // Logs any speech recognition errors
    socket.on('response', (data) => { // Receives and displays AI responses
      messageHistory.push({ role: "assistant", content: data.response });
      let formattedResponse = marked.parse(data.response); // Formats text with Markdown
      // Converts code blocks to previews or highlighted code
      formattedResponse = formattedResponse.replace(/```(\w+)?\n([\s\S]+?)```/g, (match, lang, code) => {
        if (lang === 'html') {
          return `<iframe srcdoc="${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}" sandbox></iframe>`;
        } else {
          return `<pre class="language-${lang || 'plaintext'}"><code>${Prism.highlight(code, Prism.languages[lang || 'plaintext'], lang || 'plaintext')}</code></pre>`;
        }
      });
      document.getElementById("chat-box").innerHTML += `<div class="message donna-message"><p>${formattedResponse}</p></div>`;
      const utterance = new SpeechSynthesisUtterance(data.response); // Sets up text-to-speech
      utterance.lang = 'en-US'; // Language for speech output
      window.speechSynthesis.speak(utterance);
      document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
    });
    document.getElementById("user-input").addEventListener("keypress", (event) => { // Sends message on Enter key
      if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
      }
    });
    let namespaceDropdownShown = false; // Tracks if dropdown is visible
    document.getElementById("user-input").addEventListener("focus", () => { // Shows namespace dropdown on focus
      if (!namespaceDropdownShown) {
        document.getElementById("namespace-selector").style.display = "block";
        namespaceDropdownShown = true;
      }
    });
    function sendMessage() { // Sends user message to backend
      const userInput = document.getElementById("user-input").value.trim();
      if (userInput === "") return;
      messageHistory.push({ role: "user", content: userInput });
      document.getElementById("chat-box").innerHTML += `<div class="message user-message"><p>${userInput}</p></div>`;
      document.getElementById("user-input").value = "";
      socket.emit('message', { messages: messageHistory, namespace: document.getElementById("namespace-selector").value });
    }
    function clearChat() { // Clears the current chat
      messageHistory = [];
      document.getElementById("chat-box").innerHTML = "";
    }
    function toggleMenu() { // Toggles the mobile menu
      var menu = document.getElementById("mobileNav");
      menu.style.display = menu.style.display === "block" ? "none" : "block";
    }
    function validateLogin() { // Checks login password
      const inputCode = document.getElementById('loginCode').value.trim();
      if (inputCode === 'hemmelig') {
        document.getElementById('loginOverlay').style.display = 'none';
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }
    document.getElementById('micBtn').addEventListener('click', () => { // Toggles microphone
      if (recognition.state === 'listening') {
        recognition.stop();
        document.getElementById('micBtn').classList.remove('mic-active');
      } else {
        recognition.start();
        document.getElementById('micBtn').classList.add('mic-active');
      }
    });
    async function uploadFile(event) { // Uploads files to the backend
      const files = event.target.files;
      for (let file of files) {
        let formData = new FormData();
        formData.append('file', file);
        await fetch('/upload', { method: 'POST', body: formData });
        document.getElementById("chat-box").innerHTML += `<div class="message user-message"><p>Uploaded ${file.name}</p></div>`;
        document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
      }
    }
    document.getElementById('file-upload').addEventListener('change', uploadFile); // Triggers file upload on selection
    async function loadHistory() { // Loads chat history from backend
      const response = await fetch('/history');
      const chats = await response.json();
      const historyDiv = document.getElementById('chat-history');
      historyDiv.innerHTML = chats.map(chat => `<button onclick="loadChat(${chat.id})">${chat.title}</button>`).join('');
    }
    async function loadChat(chatId) { // Loads a specific chat by ID
      const response = await fetch(`/chat?chat_id=${chatId}`);
      const messages = await response.json();
      messageHistory = messages;
      document.getElementById("chat-box").innerHTML = messages.map(m => `<div class="message ${m.role}-message"><p>${m.content}</p></div>`).join('');
      document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
    }
    loadHistory(); // Loads history when the page opens
  </script>
</body>
</html>
